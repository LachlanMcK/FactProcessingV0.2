"use strict";
/** This file contains a function to turn JSRE produced meta-data into schema meta-data for mongoose
*/
Object.defineProperty(exports, "__esModule", { value: true });
/**
 *
 * This function inputs two meta-data javascript files produced by the JSRE and outputs mongoose schema defintion
 *
 * @param formDef - this takes the JSRE program <jsre-form-name>form.js
 *                  this meta-data file contains the mapping of formlineitem ids to their domain types
 * @param formMetaData  - this takes the <jsre-form-name> object in the JSRE program <jsre-form-name>mapping.js
 * @returns - an object that contains:
 *              schema - the mongoose schema
 *              byId - a lookup object to map Section/Field Ids to meaningful section names/ field usage & names
 *              byName - a lookup object to map meaningful field names to section/field ids
 */
function getFormDescription(formDef, formMetaData) {
    const formsTypesToMongooseTypes = {
        'C': 'String',
        'I': 'String',
        'D': 'Date',
        'Y': 'Number',
        'Q': 'Number',
        'A': 'Number',
        'N': 'Number',
        'X': 'Number',
        'U': 'Number',
        'M': 'Number' //u_integer
    };
    let fDef_Schema = {};
    let fDef_byId = {};
    let fDef_Name = {};
    let sId, fId;
    let sName, fUsageName, fName, fldName;
    function newSection(sId, sName) {
        fDef_byId[sId] = { sName: sName };
        if (fDef_Name[sName])
            fDef_Name[sName].sIds.push(sId);
        else {
            fDef_Name[sName] = {};
            fDef_Name[sName].sIds = [sId];
        }
        return {}; //for some reason can't have alias here sId != sName ? { alias: fDef_Name[sName].sIds[0] } : {} //return the first section id as the alias where a name is supplied
    }
    function newField(sId, sName, fId, fUsageName, fName) {
        let fldName = fName;
        if (fUsageName) {
            if (!fDef_Schema[sName][fUsageName])
                fDef_Schema[sName][fUsageName] = {};
            fldName = (fUsageName ? (fUsageName + ".") : "") + fName;
            fDef_Schema[sName][fUsageName][fName] = { alias: fId };
        }
        else
            fDef_Schema[sName][fName] = fId == fName ? {} : { alias: fId };
        fDef_Name[sName][fldName] = { sId: sId, fId: fId };
        fDef_byId[sId][fId] = [fUsageName, fName];
        return fldName;
    }
    Object.keys(formDef.sections).forEach((sId) => fDef_Schema[formDef.sections[sId]] = newSection(sId, formDef.sections[sId]));
    formDef.fields.forEach((f) => {
        [sId, fId, fUsageName, fName] = f;
        sName = formDef.sections[sId];
        if (!fDef_Name[sName])
            fDef_Schema[sName] = newSection(sId, sName); //shouldn't be the case but coudld possibly find new section
        fldName = newField(sId, sName, fId + "", fUsageName, fName);
    });
    formMetaData.sections.forEach((s) => {
        if (!fDef_byId[s.id])
            fDef_Schema[s.id] = newSection(s.id, s.id); //don't need an alias here
        const sName = fDef_byId[s.id].sName;
        if (s.fields)
            s.fields.forEach((f) => {
                if (f.id == "id" || f.id == "fields" || f.id == "validateRules" || f.id == "updateRules") { }
                else {
                    if (!fDef_byId[s.id][f.id])
                        fldName = newField(s.id, sName, f.id, "", f.id); //discovered a new field not in formDef, so usage = "" and name will be the id
                    [fUsageName, fName] = fDef_byId[s.id][f.id];
                    let field;
                    if (fUsageName == "")
                        field = fDef_Schema[sName][fName];
                    else
                        field = fDef_Schema[sName][fUsageName][fName];
                    field.type = formsTypesToMongooseTypes[f.type];
                    if (f.groupId) {
                        field.type = [];
                        field.type.push(formsTypesToMongooseTypes[f.type]);
                        fDef_byId[s.id][f.id].groupId = f.groupId;
                    }
                    console.assert(field.type, JSON.stringify(f));
                    if (f.maxLength)
                        fDef_byId[s.id][f.id].maxLength = field.maxlength = f.maxLength;
                    console.log(field.type, JSON.stringify(f));
                }
            });
    });
    return { schema: fDef_Schema, byId: fDef_byId, byName: fDef_Name };
}
exports.getFormDescription = getFormDescription;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRm9ybUxpbmVJdGVtU2NoZW1hRnJvbUpTUkUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJGb3JtTGluZUl0ZW1TY2hlbWFGcm9tSlNSRS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7RUFDRTs7QUF5QkY7Ozs7Ozs7Ozs7O0dBV0c7QUFDSCxTQUFnQixrQkFBa0IsQ0FBQyxPQUFZLEVBQUUsWUFBaUI7SUFFOUQsTUFBTSx5QkFBeUIsR0FBUTtRQUNuQyxHQUFHLEVBQUUsUUFBUTtRQUNiLEdBQUcsRUFBRSxRQUFRO1FBQ2IsR0FBRyxFQUFFLE1BQU07UUFDWCxHQUFHLEVBQUUsUUFBUTtRQUNiLEdBQUcsRUFBRSxRQUFRO1FBQ2IsR0FBRyxFQUFFLFFBQVE7UUFDYixHQUFHLEVBQUUsUUFBUTtRQUNiLEdBQUcsRUFBRSxRQUFRO1FBQ2IsR0FBRyxFQUFFLFFBQVE7UUFDYixHQUFHLEVBQUUsUUFBUSxDQUFDLFdBQVc7S0FDNUIsQ0FBQTtJQUVELElBQUksV0FBVyxHQUFRLEVBQUUsQ0FBQztJQUMxQixJQUFJLFNBQVMsR0FBUSxFQUFFLENBQUM7SUFDeEIsSUFBSSxTQUFTLEdBQVEsRUFBRSxDQUFDO0lBQ3hCLElBQUksR0FBVyxFQUFFLEdBQVcsQ0FBQztJQUM3QixJQUFJLEtBQWEsRUFBRSxVQUFrQixFQUFFLEtBQWEsRUFBRSxPQUF3QixDQUFDO0lBRS9FLFNBQVMsVUFBVSxDQUFDLEdBQVEsRUFBRSxLQUFVO1FBQ3BDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQztRQUNsQyxJQUFJLFNBQVMsQ0FBQyxLQUFLLENBQUM7WUFDaEIsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDL0I7WUFDRCxTQUFTLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ3RCLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNqQztRQUNELE9BQU8sRUFBRSxDQUFDLENBQUMsbUtBQW1LO0lBQ2xMLENBQUM7SUFFRCxTQUFTLFFBQVEsQ0FBQyxHQUFXLEVBQUUsS0FBc0IsRUFBRSxHQUFXLEVBQUUsVUFBa0IsRUFBRSxLQUFzQjtRQUMxRyxJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDcEIsSUFBSSxVQUFVLEVBQUU7WUFDWixJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDLFVBQVUsQ0FBQztnQkFDL0IsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUN4QyxPQUFPLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUM7WUFDekQsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxDQUFDO1NBQzFEOztZQUVHLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBRW5FLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBQ25ELFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUMxQyxPQUFPLE9BQU8sQ0FBQztJQUNuQixDQUFDO0lBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBUSxFQUFFLEVBQUUsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFakksT0FBTyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFNLEVBQUUsRUFBRTtRQUM5QixDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNsQyxLQUFLLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUU5QixJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQztZQUNqQixXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsVUFBVSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLDREQUE0RDtRQUU3RyxPQUFPLEdBQUcsUUFBUSxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsR0FBRyxHQUFFLEVBQUUsRUFBRyxVQUFVLEVBQUUsS0FBSyxDQUFDLENBQUE7SUFDL0QsQ0FBQyxDQUFDLENBQUM7SUFHSCxZQUFZLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQU0sRUFBRSxFQUFFO1FBQ3JDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUNoQixXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLDBCQUEwQjtRQUUxRSxNQUFNLEtBQUssR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQTtRQUVuQyxJQUFJLENBQUMsQ0FBQyxNQUFNO1lBQ1IsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFNLEVBQUUsRUFBRTtnQkFDeEIsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLElBQUksSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLFFBQVEsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLGVBQWUsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLGFBQWEsRUFBRSxHQUFHO3FCQUN4RjtvQkFHRCxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO3dCQUN0QixPQUFPLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLDhFQUE4RTtvQkFFbkksQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7b0JBRTVDLElBQUksS0FBVSxDQUFDO29CQUNmLElBQUksVUFBVSxJQUFJLEVBQUU7d0JBQUUsS0FBSyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQzs7d0JBQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztvQkFDNUcsS0FBSyxDQUFDLElBQUksR0FBRyx5QkFBeUIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7b0JBRS9DLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRTt3QkFDWCxLQUFLLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQzt3QkFDaEIsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMseUJBQXlCLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7d0JBQ25ELFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFBO3FCQUM1QztvQkFFRCxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUM5QyxJQUFJLENBQUMsQ0FBQyxTQUFTO3dCQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUM7b0JBRWpGLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQzlDO1lBQ0wsQ0FBQyxDQUFDLENBQUE7SUFDVixDQUFDLENBQUMsQ0FBQztJQUVILE9BQU8sRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxDQUFDO0FBQ3ZFLENBQUM7QUFqR0QsZ0RBaUdDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqIFRoaXMgZmlsZSBjb250YWlucyBhIGZ1bmN0aW9uIHRvIHR1cm4gSlNSRSBwcm9kdWNlZCBtZXRhLWRhdGEgaW50byBzY2hlbWEgbWV0YS1kYXRhIGZvciBtb25nb29zZVxyXG4qL1xyXG5cclxuXHJcbi8vIGV4cG9ydCBmdW5jdGlvbiBmb3JtTWV0YURhdGF4Q2hhbmdlZERpcmVjdGlvbihmb3JtRGVmOiBhbnksIGZvcm1NZXRhRGF0YTogYW55KSB7XHJcbi8vICAgICBsZXQgbXlNYXBJZDogYW55ID0ge30sIG15TWFwTmFtZTogYW55ID0ge307XHJcbi8vICAgICBPYmplY3Qua2V5cyhmb3JtRGVmLnNlY3Rpb25zKS5mb3JFYWNoKChzSWQpID0+IHtcclxuLy8gICAgICAgICBsZXQgc05hbWU6IGFueSA9IG15TWFwSWRbc0lkXSA9IHsgc05hbWU6IGZvcm1EZWYuc2VjdGlvbnNbc0lkXSB9O1xyXG4vLyAgICAgICAgIGxldCBhID0gKG15TWFwTmFtZVtzTmFtZV0gfHwgW10pLnB1c2goc0lkKTtcclxuLy8gICAgICAgICBteU1hcE5hbWVbc05hbWVdID0geyBzSWRzOiBhIH07XHJcbi8vICAgICB9KTtcclxuLy8gICAgIGZvcm1EZWYuZmllbGRzLmZvckVhY2goKGY6IGFueSkgPT4ge1xyXG4vLyAgICAgICAgIGxldCBbc0lkLCBmSWQsIGZVc2csIGZOYW1lXSA9IFsuLi5mXTtcclxuLy8gICAgICAgICBpZiAoIW15TWFwSWRbc0lkXSkge1xyXG4vLyAgICAgICAgICAgICBteU1hcElkW3NJZF0gPSB7IHNOYW1lOiBzSWQgfTtcclxuLy8gICAgICAgICAgICAgbXlNYXBOYW1lW3NJZF0gPSB7IHNJZHM6IFtzSWRdIH07XHJcbi8vICAgICAgICAgfVxyXG4vLyAgICAgICAgIGxldCBmbGROYW1lID0gZlVzZyA/IChmVXNnICsgXCIuXCIpIDogXCJcIiArIGZOYW1lO1xyXG4vLyAgICAgICAgIGxldCBzTmFtZSA9IG15TWFwSWRbc0lkXS5zTmFtZTtcclxuLy8gICAgICAgICBteU1hcE5hbWVbc05hbWVdW2ZsZE5hbWVdID0geyBzSWQ6IHNJZCwgZklkOiBmSWQgfVxyXG4vLyAgICAgICAgIG15TWFwSWRbc0lkXVtmSWRdID0geyBzTmFtZTogc05hbWUsIGZOYW1lOiBmbGROYW1lIH1cclxuLy8gICAgIH0pO1xyXG4vLyB9XHJcblxyXG5cclxuaW1wb3J0ICogYXMgbW9uZ29vc2UgZnJvbSBcIm1vbmdvb3NlXCI7XHJcbi8qKlxyXG4gKiBcclxuICogVGhpcyBmdW5jdGlvbiBpbnB1dHMgdHdvIG1ldGEtZGF0YSBqYXZhc2NyaXB0IGZpbGVzIHByb2R1Y2VkIGJ5IHRoZSBKU1JFIGFuZCBvdXRwdXRzIG1vbmdvb3NlIHNjaGVtYSBkZWZpbnRpb25cclxuICogXHJcbiAqIEBwYXJhbSBmb3JtRGVmIC0gdGhpcyB0YWtlcyB0aGUgSlNSRSBwcm9ncmFtIDxqc3JlLWZvcm0tbmFtZT5mb3JtLmpzIFxyXG4gKiAgICAgICAgICAgICAgICAgIHRoaXMgbWV0YS1kYXRhIGZpbGUgY29udGFpbnMgdGhlIG1hcHBpbmcgb2YgZm9ybWxpbmVpdGVtIGlkcyB0byB0aGVpciBkb21haW4gdHlwZXNcclxuICogQHBhcmFtIGZvcm1NZXRhRGF0YSAgLSB0aGlzIHRha2VzIHRoZSA8anNyZS1mb3JtLW5hbWU+IG9iamVjdCBpbiB0aGUgSlNSRSBwcm9ncmFtIDxqc3JlLWZvcm0tbmFtZT5tYXBwaW5nLmpzXHJcbiAqIEByZXR1cm5zIC0gYW4gb2JqZWN0IHRoYXQgY29udGFpbnM6XHJcbiAqICAgICAgICAgICAgICBzY2hlbWEgLSB0aGUgbW9uZ29vc2Ugc2NoZW1hXHJcbiAqICAgICAgICAgICAgICBieUlkIC0gYSBsb29rdXAgb2JqZWN0IHRvIG1hcCBTZWN0aW9uL0ZpZWxkIElkcyB0byBtZWFuaW5nZnVsIHNlY3Rpb24gbmFtZXMvIGZpZWxkIHVzYWdlICYgbmFtZXNcclxuICogICAgICAgICAgICAgIGJ5TmFtZSAtIGEgbG9va3VwIG9iamVjdCB0byBtYXAgbWVhbmluZ2Z1bCBmaWVsZCBuYW1lcyB0byBzZWN0aW9uL2ZpZWxkIGlkc1xyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEZvcm1EZXNjcmlwdGlvbihmb3JtRGVmOiBhbnksIGZvcm1NZXRhRGF0YTogYW55KTogeyBzY2hlbWE6IG1vbmdvb3NlLlNjaGVtYSwgYnlJZDogYW55LCBieU5hbWU6IGFueSB9IHtcclxuXHJcbiAgICBjb25zdCBmb3Jtc1R5cGVzVG9Nb25nb29zZVR5cGVzOiBhbnkgPSB7XHJcbiAgICAgICAgJ0MnOiAnU3RyaW5nJywgLy9jaGFyXHJcbiAgICAgICAgJ0knOiAnU3RyaW5nJywgLy9pbmRpY2F0b3JcclxuICAgICAgICAnRCc6ICdEYXRlJywgICAvL2RhdGVcclxuICAgICAgICAnWSc6ICdOdW1iZXInLCAvL3llYXJcclxuICAgICAgICAnUSc6ICdOdW1iZXInLCAvL3NtYWxsIGludGVnZXJcclxuICAgICAgICAnQSc6ICdOdW1iZXInLCAvL2RlY2ltYWxcclxuICAgICAgICAnTic6ICdOdW1iZXInLCAvL3VfZGVjaW1hbFxyXG4gICAgICAgICdYJzogJ051bWJlcicsIC8vbnVtX2NoYXJcclxuICAgICAgICAnVSc6ICdOdW1iZXInLCAvL2ludGVnZXJcclxuICAgICAgICAnTSc6ICdOdW1iZXInIC8vdV9pbnRlZ2VyXHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGZEZWZfU2NoZW1hOiBhbnkgPSB7fTtcclxuICAgIGxldCBmRGVmX2J5SWQ6IGFueSA9IHt9O1xyXG4gICAgbGV0IGZEZWZfTmFtZTogYW55ID0ge307XHJcbiAgICBsZXQgc0lkOiBudW1iZXIsIGZJZDogbnVtYmVyO1xyXG4gICAgbGV0IHNOYW1lOiBzdHJpbmcsIGZVc2FnZU5hbWU6IHN0cmluZywgZk5hbWU6IHN0cmluZywgZmxkTmFtZTogbnVtYmVyIHwgc3RyaW5nO1xyXG5cclxuICAgIGZ1bmN0aW9uIG5ld1NlY3Rpb24oc0lkOiBhbnksIHNOYW1lOiBhbnkpIHtcclxuICAgICAgICBmRGVmX2J5SWRbc0lkXSA9IHsgc05hbWU6IHNOYW1lIH07XHJcbiAgICAgICAgaWYgKGZEZWZfTmFtZVtzTmFtZV0pXHJcbiAgICAgICAgICAgIGZEZWZfTmFtZVtzTmFtZV0uc0lkcy5wdXNoKHNJZCk7XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGZEZWZfTmFtZVtzTmFtZV0gPSB7fTtcclxuICAgICAgICAgICAgZkRlZl9OYW1lW3NOYW1lXS5zSWRzID0gW3NJZF07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB7fTsgLy9mb3Igc29tZSByZWFzb24gY2FuJ3QgaGF2ZSBhbGlhcyBoZXJlIHNJZCAhPSBzTmFtZSA/IHsgYWxpYXM6IGZEZWZfTmFtZVtzTmFtZV0uc0lkc1swXSB9IDoge30gLy9yZXR1cm4gdGhlIGZpcnN0IHNlY3Rpb24gaWQgYXMgdGhlIGFsaWFzIHdoZXJlIGEgbmFtZSBpcyBzdXBwbGllZFxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG5ld0ZpZWxkKHNJZDogbnVtYmVyLCBzTmFtZTogbnVtYmVyIHwgc3RyaW5nLCBmSWQ6IHN0cmluZywgZlVzYWdlTmFtZTogc3RyaW5nLCBmTmFtZTogbnVtYmVyIHwgc3RyaW5nKTogbnVtYmVyIHwgc3RyaW5nIHtcclxuICAgICAgICBsZXQgZmxkTmFtZSA9IGZOYW1lO1xyXG4gICAgICAgIGlmIChmVXNhZ2VOYW1lKSB7XHJcbiAgICAgICAgICAgIGlmICghZkRlZl9TY2hlbWFbc05hbWVdW2ZVc2FnZU5hbWVdKVxyXG4gICAgICAgICAgICAgICAgZkRlZl9TY2hlbWFbc05hbWVdW2ZVc2FnZU5hbWVdID0ge307XHJcbiAgICAgICAgICAgIGZsZE5hbWUgPSAoZlVzYWdlTmFtZSA/IChmVXNhZ2VOYW1lICsgXCIuXCIpIDogXCJcIikgKyBmTmFtZTtcclxuICAgICAgICAgICAgZkRlZl9TY2hlbWFbc05hbWVdW2ZVc2FnZU5hbWVdW2ZOYW1lXSA9IHsgYWxpYXM6IGZJZCB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIGZEZWZfU2NoZW1hW3NOYW1lXVtmTmFtZV0gPSBmSWQgPT0gZk5hbWUgPyB7fSA6IHsgYWxpYXM6IGZJZCB9O1xyXG5cclxuICAgICAgICBmRGVmX05hbWVbc05hbWVdW2ZsZE5hbWVdID0geyBzSWQ6IHNJZCwgZklkOiBmSWQgfTtcclxuICAgICAgICBmRGVmX2J5SWRbc0lkXVtmSWRdID0gW2ZVc2FnZU5hbWUsIGZOYW1lXTtcclxuICAgICAgICByZXR1cm4gZmxkTmFtZTtcclxuICAgIH1cclxuXHJcbiAgICBPYmplY3Qua2V5cyhmb3JtRGVmLnNlY3Rpb25zKS5mb3JFYWNoKChzSWQ6IGFueSkgPT4gZkRlZl9TY2hlbWFbZm9ybURlZi5zZWN0aW9uc1tzSWRdXSA9IG5ld1NlY3Rpb24oc0lkLCBmb3JtRGVmLnNlY3Rpb25zW3NJZF0pKTtcclxuXHJcbiAgICBmb3JtRGVmLmZpZWxkcy5mb3JFYWNoKChmOiBhbnkpID0+IHtcclxuICAgICAgICBbc0lkLCBmSWQsIGZVc2FnZU5hbWUsIGZOYW1lXSA9IGY7XHJcbiAgICAgICAgc05hbWUgPSBmb3JtRGVmLnNlY3Rpb25zW3NJZF07XHJcblxyXG4gICAgICAgIGlmICghZkRlZl9OYW1lW3NOYW1lXSlcclxuICAgICAgICAgICAgZkRlZl9TY2hlbWFbc05hbWVdID0gbmV3U2VjdGlvbihzSWQsIHNOYW1lKTsgLy9zaG91bGRuJ3QgYmUgdGhlIGNhc2UgYnV0IGNvdWRsZCBwb3NzaWJseSBmaW5kIG5ldyBzZWN0aW9uXHJcblxyXG4gICAgICAgIGZsZE5hbWUgPSBuZXdGaWVsZChzSWQsIHNOYW1lLCBmSWQrIFwiXCIgLCBmVXNhZ2VOYW1lLCBmTmFtZSlcclxuICAgIH0pO1xyXG5cclxuXHJcbiAgICBmb3JtTWV0YURhdGEuc2VjdGlvbnMuZm9yRWFjaCgoczogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKCFmRGVmX2J5SWRbcy5pZF0pXHJcbiAgICAgICAgICAgIGZEZWZfU2NoZW1hW3MuaWRdID0gbmV3U2VjdGlvbihzLmlkLCBzLmlkKTsgLy9kb24ndCBuZWVkIGFuIGFsaWFzIGhlcmVcclxuXHJcbiAgICAgICAgY29uc3Qgc05hbWUgPSBmRGVmX2J5SWRbcy5pZF0uc05hbWVcclxuXHJcbiAgICAgICAgaWYgKHMuZmllbGRzKVxyXG4gICAgICAgICAgICBzLmZpZWxkcy5mb3JFYWNoKChmOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChmLmlkID09IFwiaWRcIiB8fCBmLmlkID09IFwiZmllbGRzXCIgfHwgZi5pZCA9PSBcInZhbGlkYXRlUnVsZXNcIiB8fCBmLmlkID09IFwidXBkYXRlUnVsZXNcIikgeyB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuXHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmICghZkRlZl9ieUlkW3MuaWRdW2YuaWRdKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmbGROYW1lID0gbmV3RmllbGQocy5pZCwgc05hbWUsIGYuaWQsIFwiXCIsIGYuaWQpOyAvL2Rpc2NvdmVyZWQgYSBuZXcgZmllbGQgbm90IGluIGZvcm1EZWYsIHNvIHVzYWdlID0gXCJcIiBhbmQgbmFtZSB3aWxsIGJlIHRoZSBpZFxyXG5cclxuICAgICAgICAgICAgICAgICAgICBbZlVzYWdlTmFtZSwgZk5hbWVdID0gZkRlZl9ieUlkW3MuaWRdW2YuaWRdO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBsZXQgZmllbGQ6IGFueTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZlVzYWdlTmFtZSA9PSBcIlwiKSBmaWVsZCA9IGZEZWZfU2NoZW1hW3NOYW1lXVtmTmFtZV07IGVsc2UgZmllbGQgPSBmRGVmX1NjaGVtYVtzTmFtZV1bZlVzYWdlTmFtZV1bZk5hbWVdO1xyXG4gICAgICAgICAgICAgICAgICAgIGZpZWxkLnR5cGUgPSBmb3Jtc1R5cGVzVG9Nb25nb29zZVR5cGVzW2YudHlwZV07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmLmdyb3VwSWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQudHlwZSA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWVsZC50eXBlLnB1c2goZm9ybXNUeXBlc1RvTW9uZ29vc2VUeXBlc1tmLnR5cGVdKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZkRlZl9ieUlkW3MuaWRdW2YuaWRdLmdyb3VwSWQgPSBmLmdyb3VwSWRcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuYXNzZXJ0KGZpZWxkLnR5cGUsIEpTT04uc3RyaW5naWZ5KGYpKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZi5tYXhMZW5ndGgpIGZEZWZfYnlJZFtzLmlkXVtmLmlkXS5tYXhMZW5ndGggPSBmaWVsZC5tYXhsZW5ndGggPSBmLm1heExlbmd0aDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZmllbGQudHlwZSwgSlNPTi5zdHJpbmdpZnkoZikpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHsgc2NoZW1hOiBmRGVmX1NjaGVtYSwgYnlJZDogZkRlZl9ieUlkLCBieU5hbWU6IGZEZWZfTmFtZSB9O1xyXG59Il19