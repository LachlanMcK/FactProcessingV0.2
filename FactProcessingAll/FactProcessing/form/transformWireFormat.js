"use strict";
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const myLog = __importStar(require("../../myLog"));
// the legacy JSRE "wire" format of a form has each section as a property of the form.
// This is stored in meaningful names as documented in Form Meta Data.
// This function turns the meaningful stored format back to the JSRE wire format
function transformMeaningfulStorageToJSREWireFormat(form, fMetaDataByName, formMetaDataById) {
    function transform(form, fMetaDataByName, dataItem, sName, fUsage, fName, lookupName) {
        if (fMetaDataByName[sName][lookupName]) {
            const { sId, fId } = (fMetaDataByName[sName][lookupName]);
            if (!form[sId])
                form[sId] = {};
            if (dataItem && dataItem.constructor === Array)
                form[sId][fId] = { _values: dataItem, _value: dataItem[0], index: 0 };
            else
                form[sId][fId] = { _value: dataItem };
            if (fUsage)
                delete form[sName][fUsage][fName];
            else
                delete form[sName][fName];
            return true;
        }
        else
            return false;
    }
    Object.keys(form).forEach((sName) => {
        if (sName !== "sIds" && fMetaDataByName[sName]) {
            Object.keys(form[sName]).forEach((fNameOrFUsage) => {
                let transformed = transform(form, fMetaDataByName, form[sName][fNameOrFUsage], sName, "", fNameOrFUsage, fNameOrFUsage);
                if (!transformed && form[sName][fNameOrFUsage])
                    Object.keys(form[sName][fNameOrFUsage]).forEach((fName) => {
                        transformed = transform(form, fMetaDataByName, form[sName][fNameOrFUsage][fName], sName, fNameOrFUsage, fName, fNameOrFUsage + "." + fName);
                    });
                if (form[sName][fNameOrFUsage] && Object.keys(form[sName][fNameOrFUsage]).length == 0)
                    delete form[sName][fNameOrFUsage];
                if (!transformed)
                    myLog.warn("Couldnt find %s & %s in metadata, so no transformation done", sName, fNameOrFUsage);
            });
            if (Object.keys(form[sName]).length == 0)
                delete form[sName];
        }
    });
    myLog.debug(`form details after transformed to wire format: ${JSON.stringify(form).substr(0, 200)}...`);
    myLog.log(form);
    return form;
}
exports.transformMeaningfulStorageToJSREWireFormat = transformMeaningfulStorageToJSREWireFormat;
// the current legacy "wire" format of a form has each section as a property of the form.
// I couldn't figure out how to "type" that in mongoose.  So instead forms are stored with 
// an array of Sections.  This function converts the stored format of a form back to the public format.
function transformLegacyStorageToWireFormat(form) {
    myLog.debug("Transform to Wire format");
    //delete form.kind;
    for (let i = 0; i < form.Sections.length; i++) {
        let thisSecId = form.Sections[i].SectionId;
        form[thisSecId] = {};
        for (let j = 0; j < form.Sections[i].LineItems.length; j++) {
            let thisFieldId = form.Sections[i].LineItems[j].FieldId;
            form[thisSecId][thisFieldId] = {
                index: form.Sections[i].LineItems[j].FieldIndex,
                _value: form.Sections[i].LineItems[j].Value
            };
        }
    }
    delete form.Sections;
    myLog.debug(`form details after transformed to wire format: ${JSON.stringify(form).substr(0, 200)}...`);
    myLog.log(form);
    return form;
}
exports.transformLegacyStorageToWireFormat = transformLegacyStorageToWireFormat;
function transformFromLegacyJSREToExplicitStorageFormat(formLineItems, fMetaDataById) {
    Object.keys(formLineItems).forEach((sId) => {
        if (sId.length == 5) {
            Object.keys(formLineItems[sId]).forEach((fId) => {
                if (formLineItems[sId][fId].constructor.name == "FdfValue") {
                    const sName = fMetaDataById[sId].sName, [fUsage, fName] = fMetaDataById[sId][fId];
                    if (!formLineItems[sName])
                        formLineItems[sName] = {};
                    if (!fUsage)
                        formLineItems[sName][fName] = (formLineItems[sId][fId]._values) ? formLineItems[sId][fId]._values : formLineItems[sId][fId]._value;
                    else {
                        if (!formLineItems[sName][fUsage])
                            formLineItems[sName][fUsage] = {};
                        formLineItems[sName][fUsage][fName] = (formLineItems[sId][fId]._values) ? formLineItems[sId][fId]._values : formLineItems[sId][fId]._value;
                    }
                    delete formLineItems[sId][fId];
                }
            });
            if (Object.keys(formLineItems[sId]).length == 0)
                delete formLineItems[sId];
        }
    });
    myLog.debug(`form details after transformed to explicit storage format: ${JSON.stringify(formLineItems).substr(0, 200)}...`);
    myLog.log(formLineItems);
}
exports.transformFromLegacyJSREToExplicitStorageFormat = transformFromLegacyJSREToExplicitStorageFormat;
function transformFromLegacyJSREToStorageFormat_old(formLineItems, formMetaData, formDef) {
    formLineItems.Sections = [];
    for (let i = 0; i < formMetaData.sections.length; i++) {
        let thisSecId = formMetaData.sections[i].id;
        if (formLineItems[thisSecId]) {
            let newLineItems = [];
            for (let j = 0; j < (formMetaData.sections[i].fields || []).length; j++) {
                let thisFieldId = formMetaData.sections[i].fields[j].id;
                if (formLineItems[thisSecId][thisFieldId]) {
                    const newLI = {
                        FieldId: thisFieldId,
                        FieldIndex: formLineItems[thisSecId][thisFieldId].index,
                        Value: formLineItems[thisSecId][thisFieldId]._values ? formLineItems[thisSecId][thisFieldId]._values : formLineItems[thisSecId][thisFieldId]._value
                    };
                    newLineItems.push(newLI);
                }
            }
            let newSection = { SectionId: formMetaData.sections[i].id, LineItems: newLineItems };
            formLineItems.Sections.push(newSection);
            formLineItems[thisSecId] = null;
        }
    }
}
exports.transformFromLegacyJSREToStorageFormat_old = transformFromLegacyJSREToStorageFormat_old;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNmb3JtV2lyZUZvcm1hdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRyYW5zZm9ybVdpcmVGb3JtYXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsbURBQXFDO0FBQ3JDLHNGQUFzRjtBQUN0RixzRUFBc0U7QUFDdEUsZ0ZBQWdGO0FBQ2hGLFNBQWdCLDBDQUEwQyxDQUFDLElBQVMsRUFBRSxlQUduRSxFQUFFLGdCQUFzQjtJQUN6QixTQUFTLFNBQVMsQ0FBQyxJQUFTLEVBQUUsZUFHM0IsRUFBRSxRQUFhLEVBQUUsS0FBVSxFQUFFLE1BQVcsRUFBRSxLQUFVLEVBQUUsVUFBZTtRQUN0RSxJQUFJLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUN0QyxNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDMUQsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7Z0JBQ1osSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUNqQixJQUFJLFFBQVEsSUFBSSxRQUFRLENBQUMsV0FBVyxLQUFLLEtBQUs7Z0JBQzVDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUM7O2dCQUV0RSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLENBQUM7WUFDeEMsSUFBSSxNQUFNO2dCQUNSLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDOztnQkFFbEMsT0FBTyxJQUFJLENBQUMs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QUMsQ0FBQyxXQUFXLENBQUMsRUFBRTtvQkFDekMsTUFBTSxLQUFLLEdBQUc7d0JBQ1osT0FBTyxFQUFFLFdBQVc7d0JBQ3BCLFVBQVUsRUFBRSxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsS0FBSzt3QkFDdkQsS0FBSyxFQUFFLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxNQUFNO3FCQUNwSixDQUFDO29CQUNGLFlBQVksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7aUJBQzFCO2FBQ0Y7WUFDRCxJQUFJLFVBQVUsR0FBRyxFQUFFLFNBQVMsRUFBRSxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLENBQUM7WUFDckYsYUFBYSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDeEMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxHQUFHLElBQUksQ0FBQztTQUNqQztLQUNGO0FBQ0gsQ0FBQztBQXRCRCxnR0FzQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBteUxvZyBmcm9tICcuLi8uLi9teUxvZyc7XHJcbi8vIHRoZSBsZWdhY3kgSlNSRSBcIndpcmVcIiBmb3JtYXQgb2YgYSBmb3JtIGhhcyBlYWNoIHNlY3Rpb24gYXMgYSBwcm9wZXJ0eSBvZiB0aGUgZm9ybS5cclxuLy8gVGhpcyBpcyBzdG9yZWQgaW4gbWVhbmluZ2Z1bCBuYW1lcyBhcyBkb2N1bWVudGVkIGluIEZvcm0gTWV0YSBEYXRhLlxyXG4vLyBUaGlzIGZ1bmN0aW9uIHR1cm5zIHRoZSBtZWFuaW5nZnVsIHN0b3JlZCBmb3JtYXQgYmFjayB0byB0aGUgSlNSRSB3aXJlIGZvcm1hdFxyXG5leHBvcnQgZnVuY3Rpb24gdHJhbnNmb3JtTWVhbmluZ2Z1bFN0b3JhZ2VUb0pTUkVXaXJlRm9ybWF0KGZvcm06IGFueSwgZk1ldGFEYXRhQnlOYW1lOiBbW3tcclxuICBzSWQ6IG51bWJlcjtcclxuICBmSWQ6IHN0cmluZztcclxufV1dLCBmb3JtTWV0YURhdGFCeUlkPzogYW55KSB7XHJcbiAgZnVuY3Rpb24gdHJhbnNmb3JtKGZvcm06IGFueSwgZk1ldGFEYXRhQnlOYW1lOiBbW3tcclxuICAgIHNJZDogbnVtYmVyO1xyXG4gICAgZklkOiBzdHJpbmc7XHJcbiAgfV1dLCBkYXRhSXRlbTogYW55LCBzTmFtZTogYW55LCBmVXNhZ2U6IGFueSwgZk5hbWU6IGFueSwgbG9va3VwTmFtZTogYW55KTogYm9vbGVhbiB7XHJcbiAgICBpZiAoZk1ldGFEYXRhQnlOYW1lW3NOYW1lXVtsb29rdXBOYW1lXSkge1xyXG4gICAgICBjb25zdCB7IHNJZCwgZklkIH0gPSAoZk1ldGFEYXRhQnlOYW1lW3NOYW1lXVtsb29rdXBOYW1lXSk7XHJcbiAgICAgIGlmICghZm9ybVtzSWRdKVxyXG4gICAgICAgIGZvcm1bc0lkXSA9IHt9O1xyXG4gICAgICBpZiAoZGF0YUl0ZW0gJiYgZGF0YUl0ZW0uY29uc3RydWN0b3IgPT09IEFycmF5KVxyXG4gICAgICAgIGZvcm1bc0lkXVtmSWRdID0geyBfdmFsdWVzOiBkYXRhSXRlbSwgX3ZhbHVlOiBkYXRhSXRlbVswXSwgaW5kZXg6IDAgfTtcclxuICAgICAgZWxzZVxyXG4gICAgICAgIGZvcm1bc0lkXVtmSWRdID0geyBfdmFsdWU6IGRhdGFJdGVtIH07XHJcbiAgICAgIGlmIChmVXNhZ2UpXHJcbiAgICAgICAgZGVsZXRlIGZvcm1bc05hbWVdW2ZVc2FnZV1bZk5hbWVdO1xyXG4gICAgICBlbHNlXHJcbiAgICAgICAgZGVsZXRlIGZvcm1bc05hbWVdW2ZOYW1lXTtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgICBlbHNlXHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcbiAgT2JqZWN0LmtleXMoZm9ybSkuZm9yRWFjaCgoc05hbWU6IGFueSkgPT4ge1xyXG4gICAgaWYgKHNOYW1lICE9PSBcInNJZHNcIiAmJiBmTWV0YURhdGFCeU5hbWVbc05hbWVdKSB7XHJcbiAgICAgIE9iamVjdC5rZXlzKGZvcm1bc05hbWVdKS5mb3JFYWNoKChmTmFtZU9yRlVzYWdlOiBhbnkpID0+IHtcclxuICAgICAgICBsZXQgdHJhbnNmb3JtZWQgPSB0cmFuc2Zvcm0oZm9ybSwgZk1ldGFEYXRhQnlOYW1lLCBmb3JtW3NOYW1lXVtmTmFtZU9yRlVzYWdlXSwgc05hbWUsIFwiXCIsIGZOYW1lT3JGVXNhZ2UsIGZOYW1lT3JGVXNhZ2UpO1xyXG4gICAgICAgIGlmICghdHJhbnNmb3JtZWQgJiYgZm9ybVtzTmFtZV1bZk5hbWVPckZVc2FnZV0pXHJcbiAgICAgICAgICBPYmplY3Qua2V5cyhmb3JtW3NOYW1lXVtmTmFtZU9yRlVzYWdlXSkuZm9yRWFjaCgoZk5hbWU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICB0cmFuc2Zvcm1lZCA9IHRyYW5zZm9ybShmb3JtLCBmTWV0YURhdGFCeU5hbWUsIGZvcm1bc05hbWVdW2ZOYW1lT3JGVXNhZ2VdW2ZOYW1lXSwgc05hbWUsIGZOYW1lT3JGVXNhZ2UsIGZOYW1lLCBmTmFtZU9yRlVzYWdlICsgXCIuXCIgKyBmTmFtZSk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICBpZiAoZm9ybVtzTmFtZV1bZk5hbWVPckZVc2FnZV0gJiYgT2JqZWN0LmtleXMoZm9ybVtzTmFtZV1bZk5hbWVPckZVc2FnZV0pLmxlbmd0aCA9PSAwKVxyXG4gICAgICAgICAgZGVsZXRlIGZvcm1bc05hbWVdW2ZOYW1lT3JGVXNhZ2VdO1xyXG4gICAgICAgIGlmICghdHJhbnNmb3JtZWQpXHJcbiAgICAgICAgICBteUxvZy53YXJuKFwiQ291bGRudCBmaW5kICVzICYgJXMgaW4gbWV0YWRhdGEsIHNvIG5vIHRyYW5zZm9ybWF0aW9uIGRvbmVcIiwgc05hbWUsIGZOYW1lT3JGVXNhZ2UpO1xyXG4gICAgICB9KTtcclxuICAgICAgaWYgKE9iamVjdC5rZXlzKGZvcm1bc05hbWVdKS5sZW5ndGggPT0gMClcclxuICAgICAgICBkZWxldGUgZm9ybVtzTmFtZV07XHJcbiAgICB9XHJcbiAgfSk7XHJcbiAgbXlMb2cuZGVidWcoYGZvcm0gZGV0YWlscyBhZnRlciB0cmFuc2Zvcm1lZCB0byB3aXJlIGZvcm1hdDogJHtKU09OLnN0cmluZ2lmeShmb3JtKS5zdWJzdHIoMCwgMjAwKX0uLi5gKTtcclxuICBteUxvZy5sb2coZm9ybSk7XHJcbiAgcmV0dXJuIGZvcm07XHJcbn1cclxuLy8gdGhlIGN1cnJlbnQgbGVnYWN5IFwid2lyZVwiIGZvcm1hdCBvZiBhIGZvcm0gaGFzIGVhY2ggc2VjdGlvbiBhcyBhIHByb3BlcnR5IG9mIHRoZSBmb3JtLlxyXG4vLyBJIGNvdWxkbid0IGZpZ3VyZSBvdXQgaG93IHRvIFwidHlwZVwiIHRoYXQgaW4gbW9uZ29vc2UuICBTbyBpbnN0ZWFkIGZvcm1zIGFyZSBzdG9yZWQgd2l0aCBcclxuLy8gYW4gYXJyYXkgb2YgU2VjdGlvbnMuICBUaGlzIGZ1bmN0aW9uIGNvbnZlcnRzIHRoZSBzdG9yZWQgZm9ybWF0IG9mIGEgZm9ybSBiYWNrIHRvIHRoZSBwdWJsaWMgZm9ybWF0LlxyXG5leHBvcnQgZnVuY3Rpb24gdHJhbnNmb3JtTGVnYWN5U3RvcmFnZVRvV2lyZUZvcm1hdChmb3JtOiBhbnkpIHtcclxuICBteUxvZy5kZWJ1ZyhcIlRyYW5zZm9ybSB0byBXaXJlIGZvcm1hdFwiKTtcclxuICAvL2RlbGV0ZSBmb3JtLmtpbmQ7XHJcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBmb3JtLlNlY3Rpb25zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICBsZXQgdGhpc1NlY0lkID0gZm9ybS5TZWN0aW9uc1tpXS5TZWN0aW9uSWQ7XHJcbiAgICBmb3JtW3RoaXNTZWNJZF0gPSB7fTtcclxuICAgIGZvciAobGV0IGogPSAwOyBqIDwgZm9ybS5TZWN0aW9uc1tpXS5MaW5lSXRlbXMubGVuZ3RoOyBqKyspIHtcclxuICAgICAgbGV0IHRoaXNGaWVsZElkID0gZm9ybS5TZWN0aW9uc1tpXS5MaW5lSXRlbXNbal0uRmllbGRJZDtcclxuICAgICAgZm9ybVt0aGlzU2VjSWRdW3RoaXNGaWVsZElkXSA9IHtcclxuICAgICAgICBpbmRleDogZm9ybS5TZWN0aW9uc1tpXS5MaW5lSXRlbXNbal0uRmllbGRJbmRleCxcclxuICAgICAgICBfdmFsdWU6IGZvcm0uU2VjdGlvbnNbaV0uTGluZUl0ZW1zW2pdLlZhbHVlXHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgfVxyXG4gIGRlbGV0ZSBmb3JtLlNlY3Rpb25zO1xyXG4gIG15TG9nLmRlYnVnKGBmb3JtIGRldGFpbHMgYWZ0ZXIgdHJhbnNmb3JtZWQgdG8gd2lyZSBmb3JtYXQ6ICR7SlNPTi5zdHJpbmdpZnkoZm9ybSkuc3Vic3RyKDAsIDIwMCl9Li4uYCk7XHJcbiAgbXlMb2cubG9nKGZvcm0pO1xyXG4gIHJldHVybiBmb3JtO1xyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiB0cmFuc2Zvcm1Gcm9tTGVnYWN5SlNSRVRvRXhwbGljaXRTdG9yYWdlRm9ybWF0KGZvcm1MaW5lSXRlbXM6IGFueSwgZk1ldGFEYXRhQnlJZDogYW55KSB7XHJcbiAgT2JqZWN0LmtleXMoZm9ybUxpbmVJdGVtcykuZm9yRWFjaCgoc0lkOiBhbnkpID0+IHtcclxuICAgIGlmIChzSWQubGVuZ3RoID09IDUpIHtcclxuICAgICAgT2JqZWN0LmtleXMoZm9ybUxpbmVJdGVtc1tzSWRdKS5mb3JFYWNoKChmSWQ6IGFueSkgPT4ge1xyXG4gICAgICAgIGlmIChmb3JtTGluZUl0ZW1zW3NJZF1bZklkXS5jb25zdHJ1Y3Rvci5uYW1lID09IFwiRmRmVmFsdWVcIikge1xyXG4gICAgICAgICAgY29uc3Qgc05hbWUgPSBmTWV0YURhdGFCeUlkW3NJZF0uc05hbWUsIFtmVXNhZ2UsIGZOYW1lXSA9IGZNZXRhRGF0YUJ5SWRbc0lkXVtmSWRdO1xyXG4gICAgICAgICAgaWYgKCFmb3JtTGluZUl0ZW1zW3NOYW1lXSlcclxuICAgICAgICAgICAgZm9ybUxpbmVJdGVtc1tzTmFtZV0gPSB7fTtcclxuICAgICAgICAgIGlmICghZlVzYWdlKVxyXG4gICAgICAgICAgICBmb3JtTGluZUl0ZW1zW3NOYW1lXVtmTmFtZV0gPSAoZm9ybUxpbmVJdGVtc1tzSWRdW2ZJZF0uX3ZhbHVlcykgPyBmb3JtTGluZUl0ZW1zW3NJZF1bZklkXS5fdmFsdWVzIDogZm9ybUxpbmVJdGVtc1tzSWRdW2ZJZF0uX3ZhbHVlO1xyXG4gICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICghZm9ybUxpbmVJdGVtc1tzTmFtZV1bZlVzYWdlXSlcclxuICAgICAgICAgICAgICBmb3JtTGluZUl0ZW1zW3NOYW1lXVtmVXNhZ2VdID0ge307XHJcbiAgICAgICAgICAgIGZvcm1MaW5lSXRlbXNbc05hbWVdW2ZVc2FnZV1bZk5hbWVdID0gKGZvcm1MaW5lSXRlbXNbc0lkXVtmSWRdLl92YWx1ZXMpID8gZm9ybUxpbmVJdGVtc1tzSWRdW2ZJZF0uX3ZhbHVlcyA6IGZvcm1MaW5lSXRlbXNbc0lkXVtmSWRdLl92YWx1ZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGRlbGV0ZSBmb3JtTGluZUl0ZW1zW3NJZF1bZklkXTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICBpZiAoT2JqZWN0LmtleXMoZm9ybUxpbmVJdGVtc1tzSWRdKS5sZW5ndGggPT0gMClcclxuICAgICAgICBkZWxldGUgZm9ybUxpbmVJdGVtc1tzSWRdO1xyXG4gICAgfVxyXG4gIH0pO1xyXG4gIG15TG9nLmRlYnVnKGBmb3JtIGRldGFpbHMgYWZ0ZXIgdHJhbnNmb3JtZWQgdG8gZXhwbGljaXQgc3RvcmFnZSBmb3JtYXQ6ICR7SlNPTi5zdHJpbmdpZnkoZm9ybUxpbmVJdGVtcykuc3Vic3RyKDAsIDIwMCl9Li4uYCk7XHJcbiAgbXlMb2cubG9nKGZvcm1MaW5lSXRlbXMpO1xyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiB0cmFuc2Zvcm1Gcm9tTGVnYWN5SlNSRVRvU3RvcmFnZUZvcm1hdF9vbGQoZm9ybUxpbmVJdGVtczogYW55LCBmb3JtTWV0YURhdGE6IGFueSwgZm9ybURlZjogYW55KSB7XHJcbiAgZm9ybUxpbmVJdGVtcy5TZWN0aW9ucyA9IFtdO1xyXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgZm9ybU1ldGFEYXRhLnNlY3Rpb25zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICBsZXQgdGhpc1NlY0lkID0gZm9ybU1ldGFEYXRhLnNlY3Rpb25zW2ldLmlkO1xyXG4gICAgaWYgKGZvcm1MaW5lSXRlbXNbdGhpc1NlY0lkXSkge1xyXG4gICAgICBsZXQgbmV3TGluZUl0ZW1zID0gW107XHJcbiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgKGZvcm1NZXRhRGF0YS5zZWN0aW9uc1tpXS5maWVsZHMgfHwgW10pLmxlbmd0aDsgaisrKSB7XHJcbiAgICAgICAgbGV0IHRoaXNGaWVsZElkID0gZm9ybU1ldGFEYXRhLnNlY3Rpb25zW2ldLmZpZWxkc1tqXS5pZDtcclxuICAgICAgICBpZiAoZm9ybUxpbmVJdGVtc1t0aGlzU2VjSWRdW3RoaXNGaWVsZElkXSkge1xyXG4gICAgICAgICAgY29uc3QgbmV3TEkgPSB7XHJcbiAgICAgICAgICAgIEZpZWxkSWQ6IHRoaXNGaWVsZElkLFxyXG4gICAgICAgICAgICBGaWVsZEluZGV4OiBmb3JtTGluZUl0ZW1zW3RoaXNTZWNJZF1bdGhpc0ZpZWxkSWRdLmluZGV4LFxyXG4gICAgICAgICAgICBWYWx1ZTogZm9ybUxpbmVJdGVtc1t0aGlzU2VjSWRdW3RoaXNGaWVsZElkXS5fdmFsdWVzID8gZm9ybUxpbmVJdGVtc1t0aGlzU2VjSWRdW3RoaXNGaWVsZElkXS5fdmFsdWVzIDogZm9ybUxpbmVJdGVtc1t0aGlzU2VjSWRdW3RoaXNGaWVsZElkXS5fdmFsdWVcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICBuZXdMaW5lSXRlbXMucHVzaChuZXdMSSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGxldCBuZXdTZWN0aW9uID0geyBTZWN0aW9uSWQ6IGZvcm1NZXRhRGF0YS5zZWN0aW9uc1tpXS5pZCwgTGluZUl0ZW1zOiBuZXdMaW5lSXRlbXMgfTtcclxuICAgICAgZm9ybUxpbmVJdGVtcy5TZWN0aW9ucy5wdXNoKG5ld1NlY3Rpb24pO1xyXG4gICAgICBmb3JtTGluZUl0ZW1zW3RoaXNTZWNJZF0gPSBudWxsO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=